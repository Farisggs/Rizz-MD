// Import package yang dibutuhkan
const { makeWASocket, useMultiFileAuthState, DisconnectReason } = require('@whiskeysockets/baileys')
const qrcode = require('qrcode-terminal')
const chalk = require('chalk')
const moment = require('moment')

// Configurasi bot
const config = {
    name: "ðŸ¤– MyBot-MD",
        prefix: "/",
            owner: "62812xxxxxx@s.whatsapp.net" // Ganti dengan nomor Anda
            }

            // Fungsi utama
            async function startBot() {
                console.log(chalk.yellowBright(`[ ${moment().format('HH:mm:ss')} ] Starting bot...`))
                    
                        // Load session
                            const { state, saveCreds } = await useMultiFileAuthState('auth_info')

                                // Buat koneksi WhatsApp
                                    const sock = makeWASocket({
                                            printQRInTerminal: false, // QR akan ditampilkan di console
                                                    auth: state,
                                                            browser: ['BOT-MD', 'Safari', '3.0']
                                                                })

                                                                    // Handle QR Code
                                                                        sock.ev.on('connection.update', ({ connection, qr }) => {
                                                                                if (qr) {
                                                                                            console.log(chalk.green('\nScan QR ini dengan WhatsApp:'))
                                                                                                        qrcode.generate(qr, { small: true })
                                                                                                                }
                                                                                                                        if (connection === 'open') {
                                                                                                                                    console.log(chalk.greenBright('\nBot berhasil terhubung!'))
                                                                                                                                                sendMessage(sock, config.owner, `*${config.name} aktif!* ðŸš€\nJam: ${moment().format('LLLL')}`)
                                                                                                                                                        }
                                                                                                                                                            })

                                                                                                                                                                // Simpan session
                                                                                                                                                                    sock.ev.on('creds.update', saveCreds)

                                                                                                                                                                        // Handle pesan masuk
                                                                                                                                                                            sock.ev.on('messages.upsert', async ({ messages }) => {
                                                                                                                                                                                    const m = messages[0]
                                                                                                                                                                                            if (!m.message) return
                                                                                                                                                                                                    
                                                                                                                                                                                                            const text = m.message.conversation || m.message.extendedTextMessage?.text || ''
                                                                                                                                                                                                                    const sender = m.key.remoteJid
                                                                                                                                                                                                                            const isCmd = text.startsWith(config.prefix)
                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                            // System log
                                                                                                                                                                                                                                                    console.log(chalk.cyan(`[ ${moment().format('HH:mm:ss')} ] Pesan dari ${sender.split('@')[0]}: ${text}`))

                                                                                                                                                                                                                                                            // Command handler
                                                                                                                                                                                                                                                                    if (isCmd) {
                                                                                                                                                                                                                                                                                const cmd = text.slice(config.prefix.length).trim().split(/ +/).shift().toLowerCase()
                                                                                                                                                                                                                                                                                            const args = text.split(' ').slice(1)
                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                    try {
                                                                                                                                                                                                                                                                                                                                    switch(cmd) {
                                                                                                                                                                                                                                                                                                                                                        case 'ping':
                                                                                                                                                                                                                                                                                                                                                                                await sendMessage(sock, sender, `ðŸ“ *Pong!*\nLatensi: ${Date.now() - m.messageTimestamp * 1000}ms`)
                                                                                                                                                                                                                                                                                                                                                                                                        break
                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                    case 'help':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const helpMsg = `*${config.name} Commands:*\n\n`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        + `*/ping* - Cek latency bot\n`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    + `*/help* - Menu bantuan\n`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                + `*/owner* - Info pembuat bot\n`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            + `*/time* - Waktu sekarang\n`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        + `*/quote* - Kutipan inspirasi`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await sendMessage(sock, sender, helpMsg)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        break
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    case 'time':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await sendMessage(sock, sender, `â° *Waktu Sekarang:*\n${moment().format('dddd, DD MMMM YYYY HH:mm:ss')}`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    break
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                case 'owner':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await sendMessage(sock, sender, `ðŸ‘‘ *Pemilik Bot:*\nwa.me/${config.owner.split('@')[0]}`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                break
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            case 'quote':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const quote = await getRandomQuote()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await sendMessage(sock, sender, `ðŸ’¬ *Quote of the Day*\n\n"${quote.content}"\n\n- _${quote.author}_`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    break
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                default:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await sendMessage(sock, sender, `âŒ Perintah *${cmd}* tidak dikenali! Ketik */help* untuk melihat menu.`)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.error(chalk.red('Error:', err))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await sendMessage(sock, sender, 'âš ï¸ Terjadi error saat memproses perintah!')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            })

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Handle error koneksi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    sock.ev.on('connection.update', ({ lastDisconnect }) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (lastDisconnect?.error?.output?.statusCode === DisconnectReason.loggedOut) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        console.log(chalk.red('Bot logout! Silakan scan QR lagi.'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    startBot() // Restart bot
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Fungsi bantuan
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                async function sendMessage(sock, jid, text) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await sock.sendMessage(jid, { text: text })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async function getRandomQuote() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const res = await fetch('https://api.quotable.io/random')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return await res.json()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } catch {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                content: "Hidup adalah petualangan yang berani atau tidak sama sekali.",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            author: "Helen Keller"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Jalankan bot
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        startBot().catch(err => console.log(chalk.red('Error awal:', err)))